#!/bin/bash

DEFAULT_PLAYGROUND="BowPlayground"
BOW_TAGS="https://api.github.com/repos/bow-swift/bow/tags"
NEF_TEMPLATE="https://github.com/bow-swift/nef"

#: terminal setup
bold=$(tput bold)
normal=$(tput sgr0)

red=$(tput setaf 1)
green=$(tput setaf 2)
lime=$(tput setaf 190)
reset=$(tput sgr0)

#: IN - Help

##
#   printHelp()
##
printHelp() {
    latestVersion=$(lastestBowVersion)

    echo ""
    echo "${normal}$0 ${bold}--name ${normal}<project> ${bold}--version ${normal}<number format: 0.0.0>"
    echo ""
    echo "    ${lime}${bold}name${reset}${normal} create a playground project using this name [default: $DEFAULT_PLAYGROUND]"
    echo "    ${lime}${bold}version${reset}${normal} bow's version to use [default: $latestVersion]"
    echo ""
}

#: - Playground

##
#   setBowVersion(String projectFolder, String version)
#   - Parameter `projectFolder`: path to the project folder.
#   - Parameter `version`: bow version which update Podfile.
##
setBowVersion() {
  local projectFolder="$1" # parameter `projectFolder`
  local version="$2"       # parameter `version`

  cd $projectFolder
  echo -ne "${normal}Updating ${green}bow version ($version)${reset}..."

  sed -i '' s/"~> 0.0.0"/"~> $version"/g './Podfile'
  echo " ✅"
}

##
#   lastestBowVersion(): String
#   - Return: latest bow version
##
lastestBowVersion() {
  version=$(eval curl --silent \"$BOW_TAGS\" | grep name | tr -d "\n" | cut -d',' -f 1 | awk -F': "' '{print $2}' | awk -F'"' '{print $1}')
  echo $version
}

##
#   playground(String parent, String projecName)
#   - Parameter `parent`: path to the project parent.
#   - Parameter `projecName`: playground name.
##
playground() {
  set +e

  local root="$1"          # parameter `parent`
  local projectName="$2"   # parameter `projecName`
  local projectFolder="$root/$projectName"
  local tempLog="$root/init-playground.log"
  local log="$projectFolder/nef/playground/init-playground.log"

  cd $root
  echo -ne "${normal}Installing ${green}Playground ($projectName)${reset}..."

  pod lib create "$projectName" --template-url="$NEF_TEMPLATE" 1> "$tempLog" 2>&1
  makeStructure $projectFolder
  mv "$tempLog" "$log"

  error=`grep "Errno:" "$log"`
  fatalError=`grep "fatal:" "$log"`

  if [ "${#error}" -gt 0 ] || [ "${#fatalError}" -gt 0 ]; then
    echo " ❌"
    echo "[!] ${bold}${red}error: ${reset}${bold}building plaground${normal} review '$log' for more information."
    exit 1
  else
    echo " ✅"
  fi
}

##
#   makeStructure(String folder)
#   - Parameter `folder`: path to the project folder.
##
makeStructure() {
    set +e
    local projectFolder="$1"  # parameter `folder`

    cleanStructure "$projectFolder"
    mkdir -p "$projectFolder/nef/playground"
}

cleanStructure() {
    set +e
    local projectFolder="$1"  # parameter `folder`

    rm -r "$projectFolder/nef/playground" 1>/dev/null 2>/dev/null
}


#: - MAIN
set -e

root=`pwd`
projectName=$DEFAULT_PLAYGROUND
version=$(lastestBowVersion)

while [ "$1" != "" ]; do
    case $1 in
        -v | --version | version )        shift; version=$1 ;;
        -n | --name | name )              shift; projectName=$1 ;;
        -p | --playground | playground )  shift; projectName=$1 ;;
        -h | --help )                     printHelp $@; exit 1 ;;
        * )                               printHelp $@; echo "${bold}[!] ${normal}${red}error:${reset} invalid argument: ${red}$1${reset}"; exit 1
    esac
    shift
done

projectFolder="$root/$projectName"

playground "$root" "$projectName"
setBowVersion "$projectFolder" "$version"
nefc install  "$projectFolder"
